version: '3.8'
services:
  cheese_bot:
    build: .
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER:-your-org}/cheese_bot:latest
    container_name: cheese_bot
    restart: unless-stopped
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - CLIENT_ID=${CLIENT_ID}
      - DEV_GUILD_ID=${DEV_GUILD_ID}
      - DEPLOY_TARGET=${DEPLOY_TARGET}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
    volumes:
      - ./data:/app/data
    depends_on:
      - db

  # Optional: watchtower to auto-update container when new image is available.
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --cleanup --interval 300
  db:
    image: postgres:15-alpine
    container_name: cheese_bot_db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - db_data:/var/lib/postgresql/data
    labels:
      - com.centurylinklabs.watchtower.enable="false"

volumes:
  db_data:
