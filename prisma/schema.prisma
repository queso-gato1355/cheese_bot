// prisma/schema.prisma
// PostgreSQL schema for cheese_bot
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Guild {
  id        Int             @id @default(autoincrement())
  guildId   String          @unique
  name      String?
  settings  GuildSetting?
  users     DiscordUser[]
  logs      MemberEventLog[]
  appLogs   AppLog[]
  createdAt DateTime        @default(now())
}

model GuildSetting {
  id               Int      @id @default(autoincrement())
  guild            Guild    @relation(fields: [guildId], references: [id])
  guildId          Int      @unique
  welcomeChannelId String?
  attendanceChannelId String?
  leaveChannelId   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model DiscordUser {
  id           Int      @id @default(autoincrement())
  discordId    String   @unique
  username     String
  discriminator String
  joinedAt     DateTime?
  guild        Guild?   @relation(fields: [guildId], references: [id])
  guildId      Int?
}

model MemberEventLog {
  id        Int      @id @default(autoincrement())
  guild     Guild    @relation(fields: [guildId], references: [id])
  guildId   Int
  userId    Int?
  eventType String
  meta      Json?
  createdAt DateTime @default(now())
}

enum RoleType {
  OWNER
  ADMIN
  USER
  MUTE
}

// Per-guild role mappings for the application (e.g. which role is Admin/User/Mute)
model GuildRole {
  id        Int      @id @default(autoincrement())
  guild     Guild    @relation(fields: [guildId], references: [id])
  guildId   Int
  type      RoleType
  roleId    String
  createdAt DateTime @default(now())

  @@unique([guildId, type])
}

// General application logs. Use `level` to distinguish severity (info/warn/error).
model AppLog {
  id        Int      @id @default(autoincrement())
  guild     Guild?   @relation(fields: [guildId], references: [id])
  guildId   Int?
  level     String
  message   String
  meta      Json?
  createdAt DateTime @default(now())
}

// Attendance records: store per-day attendance per user
model Attendance {
  id             Int      @id @default(autoincrement())
  guild          Guild    @relation(fields: [guildId], references: [id])
  guildId        Int
  discordUserId  String
  date           DateTime // normalized to UTC midnight
  createdAt      DateTime @default(now())

  @@unique([guildId, discordUserId, date])
  @@index([guildId, date])
}
