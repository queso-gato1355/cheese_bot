name: Build and Deploy Docker Image

on:
  workflow_call:
    secrets:
      DISCORD_WEBHOOK_URL:
        required: true
  push:
    branches:
      - main
      - development

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          if [ "${{ github.ref }}" = "refs/heads/development" ]; then
            # For development branch we still want to publish the image with the 'latest' tag
            echo "DEPLOY_TAG=latest" >> $GITHUB_OUTPUT
            echo "DEPLOY_TARGET=development" >> $GITHUB_OUTPUT
          else
            echo "DEPLOY_TAG=latest" >> $GITHUB_OUTPUT
            echo "DEPLOY_TARGET=production" >> $GITHUB_OUTPUT
          fi

      - name: Check secrets presence
        run: |
          # Do NOT print secret values. Only print whether they exist.
          if [ -n "${DISCORD_WEBHOOK_URL}" ]; then
            echo "DISCORD_WEBHOOK_URL: present"
          else
            echo "DISCORD_WEBHOOK_URL: missing"
          fi
        shell: bash

      - name: Notify Discord (start)
        id: notify_start
        if: ${{ env.DISCORD_WEBHOOK_URL != '' }}
        env:
          WEBHOOK: ${{ env.DISCORD_WEBHOOK_URL }}
          BRANCH: ${{ github.ref_name }}
        run: |
          echo 'Sending start message to Discord...'
          payload=$(jq -n --arg branch "$BRANCH" '{embeds:[{title:"Bot deployment", description:("Branch: " + $branch), fields:[{name:"Progress", value:"0%"}], color:3447003}], "tts": false }')
          # Use ?wait=true to get the created message object (includes id). Some webhook endpoints return 204 without wait.
          res=$(curl -s -H "Content-Type: application/json" -d "$payload" "$WEBHOOK?wait=true")
          # Safely extract .id from the JSON response; default to empty when missing
          msg_id=$(echo "$res" | jq -r '.id // empty')
          if [ -z "$msg_id" ] || [ "$msg_id" = "null" ]; then
            echo "Warning: could not obtain message id from webhook response. Response: $res"
            echo "message_id=" >> $GITHUB_OUTPUT
          else
            echo "message_id=$msg_id" >> $GITHUB_OUTPUT
          fi

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ steps.vars.outputs.DEPLOY_TAG }}

      - name: Notify Discord (mid)
        if: ${{ env.DISCORD_WEBHOOK_URL != '' }}
        env:
          WEBHOOK: ${{ env.DISCORD_WEBHOOK_URL }}
          MSG_ID: ${{ steps.notify_start.outputs.message_id }}
        run: |
          # update progress to 70%
          payload=$(jq -n '{embeds:[{title:"Bot deployment", description:"Building and pushing image", fields:[{name:"Progress", value:"70%"}], color:16711680}], "tts": false }')
          if [ -z "$MSG_ID" ]; then
            echo "No message id from start step — sending a new progress message"
            res=$(curl -s -H "Content-Type: application/json" -d "$payload" "$WEBHOOK?wait=true")
            echo "mid_response=$res"
          else
            # try PATCH first; if it fails, fallback to POST
            res=$(curl -s -w "%{http_code}" -o /tmp/patch_res -X PATCH -H "Content-Type: application/json" -d "$payload" "$WEBHOOK/messages/$MSG_ID")
            http_code=$res
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo "Patched existing message (id=$MSG_ID)"
            else
              echo "Patch failed (http_code=$http_code). Falling back to POST. Patch body:"; cat /tmp/patch_res
              res=$(curl -s -H "Content-Type: application/json" -d "$payload" "$WEBHOOK?wait=true")
              echo "mid_fallback_response=$res"
            fi
          fi

      - name: Notify Discord (done)
        if: ${{ env.DISCORD_WEBHOOK_URL != '' }}
        env:
          WEBHOOK: ${{ env.DISCORD_WEBHOOK_URL }}
          MSG_ID: ${{ steps.notify_start.outputs.message_id }}
        run: |
          payload=$(jq -n '{embeds:[{title:"Bot deployment", description:"Deployment finished", fields:[{name:"Progress", value:"100%"}], color:3066993}], "tts": false }')
          if [ -z "$MSG_ID" ]; then
            echo "No message id from start step — sending a final message"
            res=$(curl -s -H "Content-Type: application/json" -d "$payload" "$WEBHOOK?wait=true")
            echo "done_response=$res"
          else
            res=$(curl -s -w "%{http_code}" -o /tmp/patch_res -X PATCH -H "Content-Type: application/json" -d "$payload" "$WEBHOOK/messages/$MSG_ID")
            http_code=$res
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo "Patched final message (id=$MSG_ID)"
            else
              echo "Patch failed (http_code=$http_code). Falling back to POST. Patch body:"; cat /tmp/patch_res
              res=$(curl -s -H "Content-Type: application/json" -d "$payload" "$WEBHOOK?wait=true")
              echo "done_fallback_response=$res"
            fi
          fi
